<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break-Fix Ticket Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .filter-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .filter-group label {
            color: #555;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .filter-controls select,
        .filter-controls input[type="date"] {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            font-size: 0.95em;
            color: #333;
            appearance: none; /* Remove default select arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            min-width: 150px;
        }

        .filter-controls select:focus,
        .filter-controls input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 150px;
        }

        .dashboard-card h2 {
            color: #4a4a4a;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }

        .card-value {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pivot-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 30px;
        }

        .pivot-card {
            margin-bottom: 30px;
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .pivot-card h3 {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .pivot-card .view-toggle button {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .pivot-card .view-toggle button.active {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pivot-card .view-toggle button:hover:not(.active) {
            background-color: #e0e0e0;
        }

        .pivot-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .pivot-table th,
        .pivot-table td {
            border: 1px solid #eee;
            padding: 12px 15px;
            text-align: left;
        }

        .pivot-table th {
            background-color: #f8f8f8;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .pivot-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .pivot-table tr:hover {
            background-color: #f1f1f1;
        }

        .no-data {
            text-align: center;
            color: #777;
            padding: 20px;
            font-style: italic;
        }

        .chart-container {
            display: none; /* Hidden by default */
            max-height: 400px;
            margin-top: 20px;
        }

        .chart-container.active {
            display: block;
        }

        .popup {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-radius: 10px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .popup-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .popup-table th,
        .popup-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }

        .popup-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .clickable-count {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }

        .clickable-count:hover {
            color: #0056b3;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Break-Fix Ticket Dashboard</h1>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="customerFilter">Customer:</label>
                    <select id="customerFilter">
                        <option value="">All Customers</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">Status:</label>
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="priorityFilter">Priority:</label>
                    <select id="priorityFilter">
                        <option value="">All Priorities</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="startDateFilter">Start Date:</label>
                    <input type="date" id="startDateFilter">
                </div>
                <div class="filter-group">
                    <label for="endDateFilter">End Date:</label>
                    <input type="date" id="endDateFilter">
                </div>
            </div>
        </header>

        <section class="dashboard-grid">
            <div class="dashboard-card">
                <h2>Total Tickets</h2>
                <div class="card-value" id="totalTickets">0</div>
            </div>
            <div class="dashboard-card">
                <h2>Tickets In Progress</h2>
                <div class="card-value" id="ticketsInProgress">0</div>
            </div>
            <div class="dashboard-card">
                <h2>Tickets Completed</h2>
                <div class="card-value" id="ticketsCompleted">0</div>
            </div>
            <div class="dashboard-card">
                <h2>SLA Met Rate</h2>
                <div class="card-value" id="slaMetRate">0%</div>
            </div>
        </section>

        <section class="pivot-section">
            <div class="pivot-card">
                <h3>
                    Tickets by Customer
                    <div class="view-toggle">
                        <button class="active" onclick="toggleView('customer', 'table')">Table</button>
                        <button onclick="toggleView('customer', 'chart')">Chart</button>
                    </div>
                </h3>
                <div id="customerPivot"></div>
                <canvas id="customerChart" class="chart-container"></canvas>
            </div>

            <div class="pivot-card">
                <h3>
                    SLA At Risk
                    <div class="view-toggle">
                        <button class="active" onclick="toggleView('slaRisk', 'table')">Table</button>
                        <button onclick="toggleView('slaRisk', 'chart')">Chart</button>
                    </div>
                </h3>
                <div id="slaRiskPivot"></div>
                <canvas id="slaRiskChart" class="chart-container"></canvas>
            </div>

            <div class="pivot-card">
                <h3>
                    Scheduled Tickets
                    <div class="view-toggle">
                        <button class="active" onclick="toggleView('scheduler', 'table')">Table</button>
                        <button onclick="toggleView('scheduler', 'chart')">Chart</button>
                    </div>
                </h3>
                <div id="schedulerPivot"></div>
                <canvas id="schedulerChart" class="chart-container"></canvas>
            </div>
        </section>
    </div>

    <div id="ticketDetailsPopup" class="popup">
        <div class="popup-content">
            <span class="close-button" onclick="closePopup()">&times;</span>
            <h2 id="popupTitle">Ticket Details</h2>
            <div id="popupContent"></div>
        </div>
    </div>

    <script>
        let originalData = [];
        let filteredData = [];
        let charts = {};

        // Helper to convert date string to Date object
        function parseDateString(dateString) {
            if (dateString instanceof Date) {
                return dateString;
            }
            // Assuming MM/DD/YYYY format for consistency if parsing from string
            const parts = dateString.split('/');
            return new Date(parts[2], parts[0] - 1, parts[1]);
        }

        function loadSampleData() {
            // Updated sample data to use Date objects for consistency
            originalData = [
                { "Ticket ID": "T001", "Customer": "Customer A", "Status": "In Progress", "Priority": "P1", "Create Date": new Date('2024-01-15T10:00:00'), "Create Time": new Date('2024-01-15T10:00:00'), "Scheduled Date": new Date('2024-01-16T00:00:00'), "Completion Date": null, "SLA Status": "Within SLA" },
                { "Ticket ID": "T002", "Customer": "Customer B", "Status": "Completed", "Priority": "P2", "Create Date": new Date('2024-01-10T14:30:00'), "Create Time": new Date('2024-01-10T14:30:00'), "Scheduled Date": new Date('2024-01-11T00:00:00'), "Completion Date": new Date('2024-01-11T16:00:00'), "SLA Status": "Met SLA" },
                { "Ticket ID": "T003", "Customer": "Customer A", "Status": "Scheduled", "Priority": "P1", "Create Date": new Date('2024-01-16T17:00:00'), "Create Time": new Date('2024-01-16T17:00:00'), "Scheduled Date": new Date('2024-01-19T00:00:00'), "Completion Date": null, "SLA Status": "Within SLA" }, // SLA due in 2 days from create date (16th + 2 = 18th)
                { "Ticket ID": "T004", "Customer": "Customer C", "Status": "Action Required", "Priority": "P3", "Create Date": new Date('2024-01-12T11:00:00'), "Create Time": new Date('2024-01-12T11:00:00'), "Scheduled Date": new Date('2024-01-13T00:00:00'), "Completion Date": null, "SLA Status": "Breached SLA" },
                { "Ticket ID": "T005", "Customer": "Customer B", "Status": "In Progress", "Priority": "P2", "Create Date": new Date('2024-01-17T09:00:00'), "Create Time": new Date('2024-01-17T09:00:00'), "Scheduled Date": new Date('2024-01-18T00:00:00'), "Completion Date": null, "SLA Status": "Within SLA" },
                { "Ticket ID": "T006", "Customer": "Customer C", "Status": "Completed", "Priority": "P1", "Create Date": new Date('2024-01-13T10:00:00'), "Create Time": new Date('2024-01-13T10:00:00'), "Scheduled Date": new Date('2024-01-14T00:00:00'), "Completion Date": new Date('2024-01-14T15:00:00'), "SLA Status": "Met SLA" },
                { "Ticket ID": "T007", "Customer": "Customer A", "Status": "In Progress", "Priority": "P3", "Create Date": new Date('2024-01-18T16:30:00'), "Create Time": new Date('2024-01-18T16:30:00'), "Scheduled Date": new Date('2024-01-20T00:00:00'), "Completion Date": null, "SLA Status": "Within SLA" }, // SLA due in 2 days (18th + 2 = 20th)
                { "Ticket ID": "T008", "Customer": "Customer A", "Status": "Scheduled", "Priority": "P2", "Create Date": new Date('2024-01-18T10:00:00'), "Create Time": new Date('2024-01-18T10:00:00'), "Scheduled Date": new Date('2024-01-19T00:00:00'), "Completion Date": null, "SLA Status": "Within SLA" }, // SLA due in 1 day (18th + 1 = 19th)

                // Today's SLA at risk examples (assuming today is 2024-01-19)
                { "Ticket ID": "T009", "Customer": "Customer D", "Status": "In Progress", "Priority": "P1", "Create Date": new Date('2024-01-18T10:00:00'), "Create Time": new Date('2024-01-18T10:00:00'), "Scheduled Date": new Date('2024-01-19T00:00:00'), "Completion Date": null, "SLA Status": "Within SLA" }, // Create before 4pm, SLA due tomorrow (19th)
                { "Ticket ID": "T010", "Customer": "Customer E", "Status": "Action Required", "Priority": "P2", "Create Date": new Date('2024-01-17T17:30:00'), "Create Time": new Date('2024-01-17T17:30:00'), "Scheduled Date": new Date('2024-01-19T00:00:00'), "Completion Date": null, "SLA Status": "Within SLA" } // Create after 4pm, SLA due next day + 1 (19th)
            ];

            // Adjust sample data for "today" to be relative to the user's current date
            // This is a common practice for demos to always show relevant data
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Function to get the date 'n' days from a given date
            function getDateNDaysFrom(baseDate, nDays) {
                const newDate = new Date(baseDate);
                newDate.setDate(baseDate.getDate() + nDays);
                return newDate;
            }

            // Adjust T009 and T010 to always be "SLA At Risk" for "today"
            // T009: Create Date (today - 1 day), Create Time (before 4pm) -> SLA Due: today
            const createDateForT009 = getDateNDaysFrom(today, -1);
            originalData[8]['Create Date'] = new Date(createDateForT009.getFullYear(), createDateForT009.getMonth(), createDateForT009.getDate(), 10, 0, 0); // 10 AM
            originalData[8]['Create Time'] = new Date(createDateForT009.getFullYear(), createDateForT009.getMonth(), createDateForT009.getDate(), 10, 0, 0); // 10 AM

            // T010: Create Date (today - 2 days), Create Time (after 4pm) -> SLA Due: today
            const createDateForT010 = getDateNDaysFrom(today, -2);
            originalData[9]['Create Date'] = new Date(createDateForT010.getFullYear(), createDateForT010.getMonth(), createDateForT010.getDate(), 17, 30, 0); // 5:30 PM
            originalData[9]['Create Time'] = new Date(createDateForT010.getFullYear(), createDateForT010.getMonth(), createDateForT010.getDate(), 17, 30, 0); // 5:30 PM


            applyFilters();
            populateFilters();
        }

        function populateFilters() {
            const customers = [...new Set(originalData.map(ticket => ticket.Customer))];
            const statuses = [...new Set(originalData.map(ticket => ticket.Status))];
            const priorities = [...new Set(originalData.map(ticket => ticket.Priority))].sort();

            populateSelect('customerFilter', customers);
            populateSelect('statusFilter', statuses);
            populateSelect('priorityFilter', priorities);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
        }

        function applyFilters() {
            const customerFilter = document.getElementById('customerFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const startDateFilter = document.getElementById('startDateFilter').value;
            const endDateFilter = document.getElementById('endDateFilter').value;

            filteredData = originalData.filter(ticket => {
                const ticketDate = parseDateString(ticket['Create Date']); // Use Create Date for date range filter

                const matchesCustomer = !customerFilter || ticket.Customer === customerFilter;
                const matchesStatus = !statusFilter || ticket.Status === statusFilter;
                const matchesPriority = !priorityFilter || ticket.Priority === priorityFilter;
                const matchesStartDate = !startDateFilter || ticketDate >= new Date(startDateFilter);
                const matchesEndDate = !endDateFilter || ticketDate <= new Date(endDateFilter);

                return matchesCustomer && matchesStatus && matchesPriority && matchesStartDate && matchesEndDate;
            });

            updateDashboard();
            updateCustomerPivot();
            updateSLARiskPivot();
            updateSchedulerPivot();
        }

        function updateDashboard() {
            document.getElementById('totalTickets').textContent = filteredData.length;

            const inProgress = filteredData.filter(ticket => ticket.Status === 'In Progress' || ticket.Status === 'Action Required' || ticket.Status === 'Scheduled').length;
            document.getElementById('ticketsInProgress').textContent = inProgress;

            const completed = filteredData.filter(ticket => ticket.Status === 'Completed').length;
            document.getElementById('ticketsCompleted').textContent = completed;

            const metSla = filteredData.filter(ticket => ticket['SLA Status'] === 'Met SLA').length;
            const slaRate = filteredData.length > 0 ? ((metSla / filteredData.length) * 100).toFixed(1) : 0;
            document.getElementById('slaMetRate').textContent = `${slaRate}%`;
        }

        function updateCustomerPivot() {
            const groupedTickets = groupBy(filteredData, ticket => ticket.Customer);

            const tableData = [
                ['Customer', 'Total Tickets', 'In Progress', 'Completed', 'SLA Met Rate']
            ];

            Object.entries(groupedTickets)
                .sort(([customerA], [customerB]) => customerA.localeCompare(customerB))
                .forEach(([customer, tickets]) => {
                    const totalTickets = tickets.length;
                    const inProgress = tickets.filter(t => t.Status === 'In Progress' || t.Status === 'Action Required' || t.Status === 'Scheduled').length;
                    const completed = tickets.filter(t => t.Status === 'Completed').length;
                    const metSla = tickets.filter(t => t['SLA Status'] === 'Met SLA').length;
                    const slaRate = totalTickets > 0 ? ((metSla / totalTickets) * 100).toFixed(1) + '%' : 'N/A';

                    tableData.push([
                        customer,
                        `<span class="clickable-count" onclick="showTicketDetails('Tickets for ${customer}', '${customer}')">${totalTickets}</span>`,
                        inProgress,
                        completed,
                        slaRate
                    ]);
                });

            document.getElementById('customerPivot').innerHTML = createPivotTable(tableData);
            updateChart('customer', groupedTickets, 'Status'); // Key for chart grouping
        }


        function updateSLARiskPivot() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to start of today for comparison

            const slaRiskTickets = filteredData.filter(ticket => {
                const slaStatus = ticket['SLA Status'];
                const createDate = ticket['Create Date']; // This is already a Date object
                const createTime = ticket['Create Time']; // This is already a Date object

                // Only consider tickets that are 'Within SLA'
                if (slaStatus !== 'Within SLA') {
                    return false;
                }

                // Ensure createDate and createTime are valid Date objects
                if (!(createDate instanceof Date) || isNaN(createDate.getTime()) ||
                    !(createTime instanceof Date) || isNaN(createTime.getTime())) {
                    console.error('Invalid Create Date or Create Time for ticket:', ticket['Ticket ID'], createDate, createTime);
                    return false; // Skip if date/time is invalid
                }

                // Combine Create Date (year, month, day) and Create Time (hours, minutes, seconds)
                const createDateTime = new Date(
                    createDate.getFullYear(),
                    createDate.getMonth(),
                    createDate.getDate(),
                    createTime.getHours(),
                    createTime.getMinutes(),
                    createTime.getSeconds()
                );

                const createHour = createDateTime.getHours(); // 0-23

                let slaDueDate = new Date(createDateTime); // Start with create date and time
                slaDueDate.setHours(0, 0, 0, 0); // Set to midnight of the create date part

                // Calculate SLA Due Date based on the rules
                if (createHour < 16) { // Before 4 PM (16:00)
                    slaDueDate.setDate(slaDueDate.getDate() + 1); // End of the next day
                } else { // After or at 4 PM
                    slaDueDate.setDate(slaDueDate.getDate() + 2); // Next day + 1
                }

                // Check if the calculated SLA due date is the same as today
                return slaDueDate.getTime() === today.getTime();
            });

            // Rest of the updateSLARiskPivot function remains the same for rendering
            const groupedTickets = groupBy(slaRiskTickets, ticket => ticket.Customer);

            const tableData = [
                ['Customer', 'Tickets At Risk', 'Average Priority', 'SLA Rate']
            ];

            Object.entries(groupedTickets)
                .sort(([customerA], [customerB]) => customerA.localeCompare(customerB))
                .forEach(([customer, tickets]) => {
                    const totalTickets = tickets.length;
                    const priorities = tickets.map(t => parseInt(t.Priority ? t.Priority.replace('P', '') : 'NaN')).filter(p => !isNaN(p));
                    const avgPriority = priorities.length > 0 ? (priorities.reduce((sum, p) => sum + p, 0) / priorities.length).toFixed(1) : 'N/A';
                    const metSlaCount = tickets.filter(t => t['SLA Status'] === 'Met SLA').length; // This might be zero for 'at risk' tickets
                    const slaRate = totalTickets > 0 ? ((metSlaCount / totalTickets) * 100).toFixed(1) + '%' : 'N/A';

                    // For the clickable-count, the 'Scheduled Date' filter needs to be dynamic.
                    // Instead of passing a specific date, we indicate that it's based on the calculated SLA due date for today.
                    tableData.push([
                        customer,
                        `<span class="clickable-count" onclick="showTicketDetails('SLA At Risk - ${customer}', '${customer}', 'SLA Status', 'Within SLA', 'Calculated SLADueToday', 'true')">${totalTickets}</span>`,
                        avgPriority !== 'N/A' ? 'P' + avgPriority : 'N/A',
                        slaRate
                    ]);
                });

            document.getElementById('slaRiskPivot').innerHTML = createPivotTable(tableData);

            // Update chart if necessary
            updateChart('slaRisk', groupedTickets, 'SLA Status');
        }


        function updateSchedulerPivot() {
            const scheduledTickets = filteredData.filter(ticket => ticket.Status === 'Scheduled');
            const groupedTickets = groupBy(scheduledTickets, ticket => ticket['Scheduled Date'] ? parseDateString(ticket['Scheduled Date']).toLocaleDateString() : 'No Date');

            const tableData = [
                ['Scheduled Date', 'Total Tickets', 'In Progress', 'Action Required', 'SLA Met Rate'] // Example headers
            ];

            Object.entries(groupedTickets)
                .sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB))
                .forEach(([scheduledDate, tickets]) => {
                    const totalTickets = tickets.length;
                    const inProgress = tickets.filter(t => t.Status === 'In Progress').length;
                    const actionRequired = tickets.filter(t => t.Status === 'Action Required').length;
                    const metSlaCount = tickets.filter(t => t['SLA Status'] === 'Met SLA').length;
                    const slaRate = totalTickets > 0 ? ((metSlaCount / totalTickets) * 100).toFixed(1) + '%' : 'N/A';
                    tableData.push([
                        scheduledDate,
                        totalTickets,
                        inProgress,
                        actionRequired,
                        slaRate
                    ]);
                });

            const html = createPivotTable(tableData);
            document.getElementById('schedulerPivot').innerHTML = html;
        }

        function groupBy(array, keyFunc) {
            return array.reduce((groups, item) => {
                const key = keyFunc(item);
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(item);
                return groups;
            }, {});
        }

        function createPivotTable(data) {
            if (!data || data.length === 0) {
                return '<div class="no-data">No data available</div>';
            }

            let html = '<table class="pivot-table">';

            html += '<thead><tr>';
            data[0].forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead>';

            html += '<tbody>';
            for (let i = 1; i < data.length; i++) {
                html += '<tr>';
                data[i].forEach(cell => {
                    html += `<td>${cell}</td>`;
                });
                html += '</tr>';
            }
            html += '</tbody>';

            html += '</table>';
            return html;
        }

        function updateChart(pivotId, groupedData, groupByKey) {
            const chartCanvas = document.getElementById(`${pivotId}Chart`);
            const ctx = chartCanvas.getContext('2d');

            if (charts[pivotId]) {
                charts[pivotId].destroy(); // Destroy existing chart before creating a new one
            }

            const labels = Object.keys(groupedData);
            const dataCounts = labels.map(label => groupedData[label].length);

            charts[pivotId] = new Chart(ctx, {
                type: 'bar', // You can change this to 'pie', 'line', etc.
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Tickets',
                        data: dataCounts,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function toggleView(pivotId, viewType) {
            const tableContainer = document.getElementById(`${pivotId}Pivot`);
            const chartContainer = document.getElementById(`${pivotId}Chart`);
            const buttons = document.querySelectorAll(`#${pivotId} .view-toggle button`);

            buttons.forEach(button => button.classList.remove('active'));

            if (viewType === 'table') {
                tableContainer.style.display = 'block';
                chartContainer.style.display = 'none';
                document.querySelector(`#${pivotId} .view-toggle button:nth-child(1)`).classList.add('active');
            } else {
                tableContainer.style.display = 'none';
                chartContainer.style.display = 'block';
                document.querySelector(`#${pivotId} .view-toggle button:nth-child(2)`).classList.add('active');
                // Re-render chart to ensure it's responsive if container was hidden
                updateChart(pivotId, groupBy(filteredData.filter(t => {
                    // Re-filter data specifically for chart if needed, based on pivotId
                    if (pivotId === 'customer') return true;
                    if (pivotId === 'slaRisk') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const slaStatus = t['SLA Status'];
                        const createDate = t['Create Date'];
                        const createTime = t['Create Time'];

                        if (slaStatus !== 'Within SLA' || !(createDate instanceof Date) || isNaN(createDate.getTime()) || !(createTime instanceof Date) || isNaN(createTime.getTime())) {
                            return false;
                        }

                        const createDateTime = new Date(
                            createDate.getFullYear(), createDate.getMonth(), createDate.getDate(),
                            createTime.getHours(), createTime.getMinutes(), createTime.getSeconds()
                        );
                        const createHour = createDateTime.getHours();

                        let slaDueDate = new Date(createDateTime);
                        slaDueDate.setHours(0, 0, 0, 0);

                        if (createHour < 16) {
                            slaDueDate.setDate(slaDueDate.getDate() + 1);
                        } else {
                            slaDueDate.setDate(slaDueDate.getDate() + 2);
                        }
                        return slaDueDate.getTime() === today.getTime();
                    }
                    if (pivotId === 'scheduler') return t.Status === 'Scheduled';
                    return true;
                }), t => {
                    if (pivotId === 'customer') return t.Customer;
                    if (pivotId === 'slaRisk') return t.Customer; // Group by customer for SLA Risk chart
                    if (pivotId === 'scheduler') return t['Scheduled Date'] ? parseDateString(t['Scheduled Date']).toLocaleDateString() : 'No Date';
                    return 'Other';
                }));
            }
        }


        function showTicketDetails(title, customerName, filterKey1, filterValue1, filterKey2, filterValue2) {
            document.getElementById('popupTitle').textContent = title;
            const popupContentDiv = document.getElementById('popupContent');
            popupContentDiv.innerHTML = ''; // Clear previous content

            let ticketsToShow = filteredData.filter(ticket => ticket.Customer === customerName);

            // Apply additional filters passed from the clickable count
            if (filterKey1 && filterValue1) {
                if (filterKey1 === 'Calculated SLADueToday' && filterValue1 === 'true') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    ticketsToShow = ticketsToShow.filter(ticket => {
                        const slaStatus = ticket['SLA Status'];
                        const createDate = ticket['Create Date'];
                        const createTime = ticket['Create Time'];

                        if (slaStatus !== 'Within SLA' || !(createDate instanceof Date) || isNaN(createDate.getTime()) || !(createTime instanceof Date) || isNaN(createTime.getTime())) {
                            return false;
                        }

                        const createDateTime = new Date(
                            createDate.getFullYear(), createDate.getMonth(), createDate.getDate(),
                            createTime.getHours(), createTime.getMinutes(), createTime.getSeconds()
                        );
                        const createHour = createDateTime.getHours();

                        let slaDueDate = new Date(createDateTime);
                        slaDueDate.setHours(0, 0, 0, 0);

                        if (createHour < 16) {
                            slaDueDate.setDate(slaDueDate.getDate() + 1);
                        } else {
                            slaDueDate.setDate(slaDueDate.getDate() + 2);
                        }
                        return slaDueDate.getTime() === today.getTime();
                    });
                } else {
                    ticketsToShow = ticketsToShow.filter(ticket => ticket[filterKey1] == filterValue1);
                }
            }
            if (filterKey2 && filterValue2 && filterKey2 !== 'Calculated SLADueToday') {
                 // This filter might not be used if Calculated SLADueToday is true
                 ticketsToShow = ticketsToShow.filter(ticket => ticket[filterKey2] == filterValue2);
            }


            if (ticketsToShow.length === 0) {
                popupContentDiv.innerHTML = '<p>No tickets found for this selection.</p>';
            } else {
                let html = '<table class="popup-table">';
                html += '<thead><tr>';
                // Dynamically create headers from the first ticket's keys
                const headers = Object.keys(ticketsToShow[0]);
                headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead>';
                html += '<tbody>';
                ticketsToShow.forEach(ticket => {
                    html += '<tr>';
                    headers.forEach(header => {
                        let cellValue = ticket[header];
                        if (cellValue instanceof Date) {
                            // Format Date objects for display in popup
                            if (header === 'Create Date' || header === 'Scheduled Date' || header === 'Completion Date') {
                                cellValue = cellValue.toLocaleDateString('en-US'); // MM/DD/YYYY
                            } else if (header === 'Create Time') {
                                cellValue = cellValue.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }); // HH:MM AM/PM
                            } else {
                                cellValue = cellValue.toLocaleString(); // Generic date/time format
                            }
                        } else if (cellValue === null) {
                            cellValue = 'N/A'; // Handle null values gracefully
                        }
                        html += `<td>${cellValue}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody>';
                html += '</table>';
                popupContentDiv.innerHTML = html;
            }

            document.getElementById('ticketDetailsPopup').style.display = 'flex'; // Use flex to center
        }

        function closePopup() {
            document.getElementById('ticketDetailsPopup').style.display = 'none';
        }


        // Event Listeners for filters
        document.getElementById('customerFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('priorityFilter').addEventListener('change', applyFilters);
        document.getElementById('startDateFilter').addEventListener('change', applyFilters);
        document.getElementById('endDateFilter').addEventListener('change', applyFilters);

        // Initial load
        document.addEventListener('DOMContentLoaded', loadSampleData);
    </script>
</body>
</html>
