<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break-Fix Ticket Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .upload-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            min-height: 80px;
        }
        
        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .pivot-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .pivot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .pivot-card h3 {
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .view-toggle {
            display: flex;
            gap: 5px;
            font-size: 0.8rem;
        }
        
        .view-toggle button {
            padding: 4px 8px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }
        
        .view-toggle button.active {
            background: #667eea;
            color: white;
        }
        
        .view-toggle button:hover {
            background: #667eea;
            color: white;
        }
        
        .chart-container {
            width: 100%;
            height: 250px;
            margin-top: 15px;
            display: none;
        }
        
        .chart-container.active {
            display: block;
        }
        
        .clickable-count {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            font-weight: bold;
        }
        
        .clickable-count:hover {
            color: #4a5fd4;
            background-color: rgba(102, 126, 234, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .ticket-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .ticket-details-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .ticket-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .close-modal {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .ticket-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .ticket-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        
        .ticket-number {
            font-weight: bold;
            color: #667eea;
        }
        
        .ticket-title {
            color: #333;
            margin-top: 5px;
        }
        
        .ticket-meta {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }
        
        .pivot-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .pivot-table th,
        .pivot-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .pivot-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }
        
        .pivot-table tr:nth-child(even) {
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        .pivot-table tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        
        .filters {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1000;
            overflow: visible;
        }
        
        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            overflow: visible;
        }
        
        .filter-item {
            position: relative;
            overflow: visible;
        }
        
        .filter-dropdown {
            position: relative;
            width: 100%;
            overflow: visible;
        }
        
        .filter-button {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .filter-button:hover, .filter-button.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filter-button::after {
            content: 'â–¼';
            transition: transform 0.3s ease;
        }
        
        .filter-button.active::after {
            transform: rotate(180deg);
        }
        
        .filter-options {
            position: fixed;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 2147483647;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
        }
        
        .filter-options.show {
            display: block;
        }
        
        .filter-option {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .filter-option:hover {
            background-color: #f8f9ff;
        }
        
        .filter-option.select-all {
            border-bottom: 1px solid #eee;
            font-weight: 600;
            background-color: #f0f2ff;
        }
        
        .filter-option input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .filter-count {
            font-size: 0.8rem;
            color: #667eea;
            font-weight: 600;
        }
        
        .multiselect-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
            font-style: italic;
        }
        
        .clear-filters {
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 15px;
        }
        
        .clear-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .filter-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2rem;
        }
        
        .hidden {
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .risk-critical {
            background: #d63031;
            color: white;
        }
        
        .risk-high {
            background: #ff4757;
            color: white;
        }
        
        .risk-medium {
            background: #ffa726;
            color: white;
        }
        
        .risk-low {
            background: #26de81;
            color: white;
        }
        
        .sla-risk-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 5px;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }

        .demo-button {
            background: linear-gradient(135deg, #26de81, #20bf6b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(38, 222, 129, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Break-Fix Ticket Dashboard</h1>
            <p>Upload your Excel file to view interactive pivot table analysis</p>
        </div>
        
        <div class="upload-section">
            <div class="file-upload">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <div class="upload-button">
                    <span>ðŸ“Š</span>
                    <span>Upload Excel/CSV File</span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="demo-button" onclick="loadSampleData()">Load Demo Data</button>
            </div>
            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div id="dashboard" class="hidden">
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalTickets">0</div>
                    <div class="stat-label">Total Tickets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTickets">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="slaBreaches">0</div>
                    <div class="stat-label">SLA Breaches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeTickets">0</div>
                    <div class="stat-label">Active Tickets</div>
                </div>
            </div>
            
            <div class="filters">
                <h3>Filters</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <label for="customerFilter">Customer</label>
                        <div class="filter-dropdown">
                            <button type="button" class="filter-button" data-filter="customer">
                                <span class="filter-text">All Customers</span>
                                <span class="filter-count"></span>
                            </button>
                            <div class="filter-options" id="customerOptions"></div>
                        </div>
                    </div>
                    <div class="filter-item">
                        <label for="statusFilter">Status</label>
                        <div class="filter-dropdown">
                            <button type="button" class="filter-button" data-filter="status">
                                <span class="filter-text">All Statuses</span>
                                <span class="filter-count"></span>
                            </button>
                            <div class="filter-options" id="statusOptions"></div>
                        </div>
                    </div>
                    <div class="filter-item">
                        <label for="priorityFilter">Priority</label>
                        <div class="filter-dropdown">
                            <button type="button" class="filter-button" data-filter="priority">
                                <span class="filter-text">All Priorities</span>
                                <span class="filter-count"></span>
                            </button>
                            <div class="filter-options" id="priorityOptions"></div>
                        </div>
                    </div>
                    <div class="filter-item">
                        <label for="regionFilter">Region</label>
                        <div class="filter-dropdown">
                            <button type="button" class="filter-button" data-filter="region">
                                <span class="filter-text">All Regions</span>
                                <span class="filter-count"></span>
                            </button>
                            <div class="filter-options" id="regionOptions"></div>
                        </div>
                    </div>
                    <div class="filter-item">
                        <label for="scheduledByFilter">Scheduled By</label>
                        <div class="filter-dropdown">
                            <button type="button" class="filter-button" data-filter="scheduledBy">
                                <span class="filter-text">All Schedulers</span>
                                <span class="filter-count"></span>
                            </button>
                            <div class="filter-options" id="scheduledByOptions"></div>
                        </div>
                    </div>
                    <div class="filter-item">
                        <label for="primaryResourceFilter">Primary Resource</label>
                        <div class="filter-dropdown">
                            <button type="button" class="filter-button" data-filter="primaryResource">
                                <span class="filter-text">All Resources</span>
                                <span class="filter-count"></span>
                            </button>
                            <div class="filter-options" id="primaryResourceOptions"></div>
                        </div>
                    </div>
                </div>
                <div class="clear-filters">
                    <button id="clearAllFilters" class="clear-button">Clear All Filters</button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="pivot-card">
                    <h3>
                        Tickets by Status
                        <div class="view-toggle">
                            <button class="active" onclick="toggleView('status', 'table')">Table</button>
                            <button onclick="toggleView('status', 'chart')">Chart</button>
                        </div>
                    </h3>
                    <div id="statusPivot"></div>
                    <canvas id="statusChart" class="chart-container"></canvas>
                </div>
                
                <div class="pivot-card">
                    <h3>SLA Performance</h3>
                    <div class="sla-controls" style="margin-bottom: 15px;">
                        <label for="slaCustomerFilter" style="display: inline-block; margin-right: 10px; font-weight: 600;">Filter by Customer:</label>
                        <select id="slaCustomerFilter" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; min-width: 200px;">
                            <option value="">All Customers</option>
                        </select>
                        <button id="resetSlaFilter" style="margin-left: 10px; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Reset</button>
                    </div>
                    <div id="slaPivot"></div>
                </div>
                
                <div class="pivot-card">
                    <h3>
                        SLA At Risk
                        <div class="view-toggle">
                            <button class="active" onclick="toggleView('slaRisk', 'table')">Table</button>
                            <button onclick="toggleView('slaRisk', 'chart')">Chart</button>
                        </div>
                    </h3>
                    <div id="slaRiskPivot"></div>
                    <canvas id="slaRiskChart" class="chart-container"></canvas>
                </div>
                
                <div class="pivot-card">
                    <h3>
                        Tickets by Priority
                        <div class="view-toggle">
                            <button class="active" onclick="toggleView('priority', 'table')">Table</button>
                            <button onclick="toggleView('priority', 'chart')">Chart</button>
                        </div>
                    </h3>
                    <div id="priorityPivot"></div>
                    <canvas id="priorityChart" class="chart-container"></canvas>
                </div>
                
                <div class="pivot-card">
                    <h3>
                        Tickets by Region
                        <div class="view-toggle">
                            <button class="active" onclick="toggleView('region', 'table')">Table</button>
                            <button onclick="toggleView('region', 'chart')">Chart</button>
                        </div>
                    </h3>
                    <div id="regionPivot"></div>
                    <canvas id="regionChart" class="chart-container"></canvas>
                </div>
                
                <div class="pivot-card">
                    <h3>
                        Top Customers
                        <div class="view-toggle">
                            <button class="active" onclick="toggleView('customer', 'table')">Table</button>
                            <button onclick="toggleView('customer', 'chart')">Chart</button>
                        </div>
                    </h3>
                    <div id="customerPivot"></div>
                    <canvas id="customerChart" class="chart-container"></canvas>
                </div>
                
                <div class="pivot-card">
                    <h3>
                        Engineer Performance
                        <div class="view-toggle">
                            <button class="active" onclick="toggleView('engineer', 'table')">Table</button>
                            <button onclick="toggleView('engineer', 'chart')">Chart</button>
                        </div>
                    </h3>
                    <div id="engineerPivot"></div>
                    <canvas id="engineerChart" class="chart-container"></canvas>
                </div>
                
                <div class="pivot-card">
                    <h3>
                        Scheduler Performance
                        <div class="view-toggle">
                            <button class="active" onclick="toggleView('scheduler', 'table')">Table</button>
                            <button onclick="toggleView('scheduler', 'chart')">Chart</button>
                        </div>
                    </h3>
                    <div id="schedulerPivot"></div>
                    <canvas id="schedulerChart" class="chart-container"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket Details Modal -->
    <div id="ticketModal" class="ticket-details-modal">
        <div class="ticket-details-content">
            <div class="ticket-details-header">
                <h3 id="modalTitle">Ticket Details</h3>
                <button class="close-modal" onclick="closeTicketModal()">Ã—</button>
            </div>
            <div id="ticketList" class="ticket-list"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let originalData = [];
        let filteredData = [];
        let activeFilters = {
            customer: [],
            status: [],
            priority: [],
            region: [],
            scheduledBy: [],
            primaryResource: []
        };

        // Sample data for demo
        function loadSampleData() {
            const sampleData = [
                {
                    'Ticket Number': 'TK001',
                    'Ticket Title': 'Server Down - Production Environment',
                    'Customer': 'Acme Corp',
                    'Priority': 'P1',
                    'Status': 'In Progress',
                    'SLA Status': 'Within SLA',
                    'Create Date': new Date('2024-01-15'),
                    'Create Time': new Date('2024-01-15T09:30:00'),
                    'Scheduled Date': new Date('2024-01-15'),
                    'Scheduled time': new Date('2024-01-15T10:00:00'),
                    'Scheduled By': 'John Smith',
                    'Primary Resource': 'Mike Johnson',
                    'City': 'London',
                    'Region': 'UK',
                    'Postcode': 'SW1A 1AA'
                },
                {
                    'Ticket Number': 'TK002',
                    'Ticket Title': 'Network Connectivity Issues',
                    'Customer': 'TechCorp Ltd',
                    'Priority': 'P2',
                    'Status': 'Complete',
                    'SLA Status': 'Met SLA',
                    'Create Date': new Date('2024-01-14'),
                    'Create Time': new Date('2024-01-14T14:15:00'),
                    'Scheduled Date': new Date('2024-01-14'),
                    'Scheduled time': new Date('2024-01-14T15:00:00'),
                    'Scheduled By': 'Sarah Wilson',
                    'Primary Resource': 'David Brown',
                    'City': 'Manchester',
                    'Region': 'UK',
                    'Postcode': 'M1 1AA'
                },
                {
                    'Ticket Number': 'TK003',
                    'Ticket Title': 'Database Performance Issues',
                    'Customer': 'Global Systems',
                    'Priority': 'P3',
                    'Status': 'Action Required',
                    'SLA Status': 'Out of SLA',
                    'Create Date': new Date('2024-01-13'),
                    'Create Time': new Date('2024-01-13T11:20:00'),
                    'Scheduled Date': new Date('2024-01-16'),
                    'Scheduled time': new Date('2024-01-16T09:00:00'),
                    'Scheduled By': 'Tom Anderson',
                    'Primary Resource': 'Lisa Davis',
                    'City': 'Birmingham',
                    'Region': 'UK',
                    'Postcode': 'B1 1BB'
                },
                {
                    'Ticket Number': 'TK004',
                    'Ticket Title': 'Email Server Maintenance',
                    'Customer': 'Enterprise Solutions',
                    'Priority': 'P2',
                    'Status': 'Scheduled',
                    'SLA Status': 'Within SLA',
                    'Create Date': new Date('2024-01-12'),
                    'Create Time': new Date('2024-01-12T16:45:00'),
                    'Scheduled Date': new Date('2024-01-17'),
                    'Scheduled time': new Date('2024-01-17T18:00:00'),
                    'Scheduled By': 'John Smith',
                    'Primary Resource': 'Mike Johnson',
                    'City': 'Leeds',
                    'Region': 'UK',
                    'Postcode': 'LS1 1UR'
                },
                {
                    'Ticket Number': 'TK005',
                    'Ticket Title': 'Firewall Configuration Update',
                    'Customer': 'Acme Corp',
                    'Priority': 'P4',
                    'Status': 'Complete',
                    'SLA Status': 'Met SLA',
                    'Create Date': new Date('2024-01-11'),
                    'Create Time': new Date('2024-01-11T13:30:00'),
                    'Scheduled Date': new Date('2024-01-12'),
                    'Scheduled time': new Date('2024-01-12T14:00:00'),
                    'Scheduled By': 'Sarah Wilson',
                    'Primary Resource': 'David Brown',
                    'City': 'Edinburgh',
                    'Region': 'Scotland',
                    'Postcode': 'EH1 1YZ'
                },
                {
                    'Ticket Number': 'TK006',
                    'Ticket Title': 'Application Deployment',
                    'Customer': 'TechCorp Ltd',
                    'Priority': 'P3',
                    'Status': 'In Progress',
                    'SLA Status': 'Within SLA',
                    'Create Date': new Date('2024-01-10'),
                    'Create Time': new Date('2024-01-10T10:15:00'),
                    'Scheduled Date': new Date('2024-01-15'),
                    'Scheduled time': new Date('2024-01-15T16:30:00'),
                    'Scheduled By': 'Tom Anderson',
                    'Primary Resource': 'Lisa Davis',
                    'City': 'Glasgow',
                    'Region': 'Scotland',
                    'Postcode': 'G1 1XQ'
                },
                {
                    'Ticket Number': 'TK007',
                    'Ticket Title': 'Security Patch Installation',
                    'Customer': 'Global Systems',
                    'Priority': 'P1',
                    'Status': 'Action Required',
                    'SLA Status': 'Missed SLA',
                    'Create Date': new Date('2024-01-09'),
                    'Create Time': new Date('2024-01-09T08:00:00'),
                    'Scheduled Date': new Date('2024-01-09'),
                    'Scheduled time': new Date('2024-01-09T12:00:00'),
                    'Scheduled By': 'John Smith',
                    'Primary Resource': 'Mike Johnson',
                    'City': 'Cardiff',
                    'Region': 'Wales',
                    'Postcode': 'CF10 1EP'
                },
                {
                    'Ticket Number': 'TK008',
                    'Ticket Title': 'Backup System Check',
                    'Customer': 'Enterprise Solutions',
                    'Priority': 'P3',
                    'Status': 'Complete',
                    'SLA Status': 'Met SLA',
                    'Create Date': new Date('2024-01-08'),
                    'Create Time': new Date('2024-01-08T15:20:00'),
                    'Scheduled Date': new Date('2024-01-09'),
                    'Scheduled time': new Date('2024-01-09T09:00:00'),
                    'Scheduled By': 'Sarah Wilson',
                    'Primary Resource': 'David Brown',
                    'City': 'Belfast',
                    'Region': 'Northern Ireland',
                    'Postcode': 'BT1 1ND'
                },
                {
                    'Ticket Number': 'TK009',
                    'Ticket Title': 'VPN Access Configuration',
                    'Customer': 'International Corp',
                    'Priority': 'P2',
                    'Status': 'Scheduled',
                    'SLA Status': 'Within SLA',
                    'Create Date': new Date('2024-01-07'),
                    'Create Time': new Date('2024-01-07T12:45:00'),
                    'Scheduled Date': new Date('2024-01-18'),
                    'Scheduled time': new Date('2024-01-18T11:00:00'),
                    'Scheduled By': 'Tom Anderson',
                    'Primary Resource': 'Lisa Davis',
                    'City': 'Paris',
                    'Region': 'International',
                    'Postcode': '75001'
                },
                {
                    'Ticket Number': 'TK010',
                    'Ticket Title': 'Hardware Replacement',
                    'Customer': 'Tech Innovations',
                    'Priority': 'P2',
                    'Status': 'In Progress',
                    'SLA Status': 'Within SLA',
                    'Create Date': new Date('2024-01-06'),
                    'Create Time': new Date('2024-01-06T14:30:00'),
                    'Scheduled Date': new Date('2024-01-16'),
                    'Scheduled time': new Date('2024-01-16T13:00:00'),
                    'Scheduled By': 'John Smith',
                    'Primary Resource': 'Mike Johnson',
                    'City': 'Dublin',
                    'Region': 'International',
                    'Postcode': 'D01 F5P2'
                }
            ];

            originalData = sampleData;
            filteredData = [...originalData];
            initializeDashboard();
        }
        
        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showProgress(0);
            
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    showProgress(50);
                    processExcelData(e.target.result);
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error reading file:', error);
                alert('Error reading file. Please try again.');
                hideProgress();
            }
        }
        
        async function processExcelData(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Try to find the ticket data sheet - be more flexible with sheet names
                let sheetName = null;
                const possibleSheetNames = [
                    "Last Week's Break-Fix Tickets",
                    "Last Weeks BreakFix Tickets", 
                    "BreakFix Tickets Current Week",
                    "BreakFix Tickets Current Month",
                    "Current Week",
                    "Current Month",
                    "Break-Fix Tickets",
                    "Tickets",
                    "Data"
                ];
                
                // First try exact matches
                for (const name of possibleSheetNames) {
                    if (workbook.Sheets[name]) {
                        sheetName = name;
                        console.log(`Found sheet: ${sheetName}`);
                        break;
                    }
                }
                
                // If no exact match, try partial matches
                if (!sheetName) {
                    const availableSheets = workbook.SheetNames;
                    console.log('Available sheets:', availableSheets);
                    
                    for (const availableSheet of availableSheets) {
                        const lowerSheet = availableSheet.toLowerCase();
                        if (lowerSheet.includes('ticket') || 
                            lowerSheet.includes('break') || 
                            lowerSheet.includes('fix') ||
                            lowerSheet.includes('current') ||
                            lowerSheet.includes('week') ||
                            lowerSheet.includes('month')) {
                            sheetName = availableSheet;
                            console.log(`Found matching sheet: ${sheetName}`);
                            break;
                        }
                    }
                }
                
                // If still not found, use the first sheet
                if (!sheetName) {
                    sheetName = workbook.SheetNames[0];
                    console.log(`Using first sheet: ${sheetName}`);
                }
                
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                showProgress(75);
                
                // Load regions lookup table if available
                let regionLookup = {};
                if (workbook.Sheets["Regions"]) {
                    const regionsSheet = workbook.Sheets["Regions"];
                    const regionsData = XLSX.utils.sheet_to_json(regionsSheet, { header: 1 });
                    
                    if (regionsData.length > 1) {
                        const regionHeaders = regionsData[0];
                        const regionRows = regionsData.slice(1).filter(row => row && row.length > 0);
                        
                        regionRows.forEach((row) => {
                            const lookup = {};
                            regionHeaders.forEach((header, index) => {
                                lookup[header] = row[index];
                            });
                            
                            if (lookup.City && lookup.Region) {
                                const cleanCity = lookup.City.toString().trim();
                                regionLookup[cleanCity] = lookup.Region;
                            }
                        });
                    }
                }
                
                // Process the data - Headers in row 3, data starts from row 4
                console.log('Raw data structure:', jsonData.slice(0, 10));
                console.log('Total rows in Excel:', jsonData.length);
                
                // Try multiple header row positions
                let headers = null;
                let headerRowIndex = -1;
                let dataStartIndex = -1;
                
                // Check rows 1-5 for headers
                for (let i = 0; i < Math.min(jsonData.length, 5); i++) {
                    const row = jsonData[i];
                    if (row && row.length > 3) {
                        // Check if this row looks like headers
                        const hasTicketColumn = row.some(cell => 
                            cell && cell.toString().toLowerCase().includes('ticket')
                        );
                        const hasCustomerColumn = row.some(cell => 
                            cell && cell.toString().toLowerCase().includes('customer')
                        );
                        const hasStatusColumn = row.some(cell => 
                            cell && (cell.toString().toLowerCase().includes('status') || 
                                   cell.toString().toLowerCase().includes('satus'))
                        );
                        
                        if ((hasTicketColumn && hasCustomerColumn) || 
                            (hasTicketColumn && hasStatusColumn) ||
                            (hasCustomerColumn && hasStatusColumn)) {
                            headers = row;
                            headerRowIndex = i;
                            dataStartIndex = i + 1;
                            console.log(`Found headers at row ${i + 1}:`, headers);
                            break;
                        }
                    }
                }
                
                // Fallback to row 3 if auto-detection didn't work
                if (!headers && jsonData.length > 3) {
                    headers = jsonData[2]; // Row 3
                    headerRowIndex = 2;
                    dataStartIndex = 3;
                    console.log('Using fallback - headers from row 3:', headers);
                }
                
                if (headers && dataStartIndex >= 0 && jsonData.length > dataStartIndex) {
                    // Filter out empty data rows and rows that are clearly not data
                    const rows = jsonData.slice(dataStartIndex).filter(row => {
                        if (!row || row.length === 0) return false;
                        
                        // Skip rows that are all null/undefined/empty
                        const hasData = row.some(cell => 
                            cell !== null && cell !== undefined && cell !== ''
                        );
                        
                        return hasData;
                    });
                    
                    console.log(`Headers from row ${headerRowIndex + 1}:`, headers);
                    console.log(`Data rows starting from row ${dataStartIndex + 1}:`, rows.length);
                    console.log('Sample data rows:', rows.slice(0, 3));
                    
                    if (!headers || headers.length === 0) {
                        throw new Error(`No headers found at row ${headerRowIndex + 1}`);
                    }
                    
                    if (rows.length === 0) {
                        throw new Error(`No data rows found starting from row ${dataStartIndex + 1}`);
                    }
                    
                    if (!headers || headers.length === 0) {
                        throw new Error('No headers found in row 3');
                    }
                    
                    if (rows.length === 0) {
                        throw new Error('No data rows found starting from row 4');
                    }
                    
                    originalData = rows.map((row) => {
                        const ticket = {};
                        headers.forEach((header, index) => {
                            ticket[header] = row[index];
                        });
                        
                        // Apply region lookup if needed
                        if (ticket.City && (!ticket.Region || ticket.Region === '' || ticket.Region === null || ticket.Region === undefined)) {
                            const cleanCity = ticket.City.toString().trim();
                            
                            const lookedUpRegion = regionLookup[cleanCity];
                            if (lookedUpRegion) {
                                ticket.Region = lookedUpRegion;
                            } else {
                                // Try case-insensitive lookup
                                const cityLower = cleanCity.toLowerCase();
                                const matchingKey = Object.keys(regionLookup).find(key => 
                                    key.toLowerCase() === cityLower
                                );
                                
                                if (matchingKey) {
                                    ticket.Region = regionLookup[matchingKey];
                                } else {
                                    // Determine if it's international based on postcode patterns
                                    const postcode = ticket.Postcode || '';
                                    if (isInternationalLocation(cleanCity, postcode)) {
                                        ticket.Region = 'International';
                                    } else {
                                        ticket.Region = 'Unknown';
                                    }
                                }
                            }
                        }
                        
                        return ticket;
                    });
                    
                    filteredData = [...originalData];
                    
                    showProgress(100);
                    setTimeout(() => {
                        hideProgress();
                        initializeDashboard();
                    }, 500);
                } else {
                    throw new Error('No data found in the file or insufficient rows');
                }
            } catch (error) {
                console.error('Error processing Excel data:', error);
                alert('Error processing file. Please ensure it\'s a valid Excel file with ticket data.');
                hideProgress();
            }
        }
        
        function isInternationalLocation(city, postcode) {
            const internationalCities = [
                'Dresden', 'Hamburg', 'Paris', 'Nice', 'Serris', 'Thessaloniki', 
                'Dublin', 'Cork', 'Galway', 'Limerick', 'Waterford', 'Cavan',
                'Barcelona', 'Madrid', 'Milan', 'Rome', 'Amsterdam', 'Brussels'
            ];
            
            if (internationalCities.includes(city)) {
                return true;
            }
            
            if (postcode) {
                if (/^\d{4,5}$/.test(postcode) || 
                    /^\d{2}\s?\d{3}$/.test(postcode) || 
                    /^[A-Z]\d{2}[A-Z]\s?[A-Z]\d{2}$/.test(postcode) || 
                    /^\d{5}$/.test(postcode)) {
                    return true;
                }
            }
            
            return false;
        }
        
        function showProgress(percent) {
            document.getElementById('progressBar').classList.remove('hidden');
            document.getElementById('progressFill').style.width = percent + '%';
        }
        
        function hideProgress() {
            document.getElementById('progressBar').classList.add('hidden');
        }
        
        function initializeDashboard() {
            document.getElementById('dashboard').classList.remove('hidden');
            setupFilters();
            updateDashboard();
        }
        
        function setupFilters() {
            // Get unique values for filters
            const customers = [...new Set(originalData.map(t => t.Customer).filter(c => c))].sort();
            const statuses = [...new Set(originalData.map(t => t.Status || t.Satus).filter(s => s))].sort();
            const priorities = [...new Set(originalData.map(t => t.Priority).filter(p => p))].sort();
            const regions = [...new Set(originalData.map(t => t.Region).filter(r => r))].sort();
            const scheduledBy = [...new Set(originalData.map(t => t['Scheduled By']).filter(s => s))].sort();
            const primaryResources = [...new Set(originalData.map(t => t['Primary Resource']).filter(r => r))].sort();
            
            // Create filter dropdowns
            createFilterDropdown('customer', customers, 'customerOptions');
            createFilterDropdown('status', statuses, 'statusOptions');
            createFilterDropdown('priority', priorities, 'priorityOptions');
            createFilterDropdown('region', regions, 'regionOptions');
            createFilterDropdown('scheduledBy', scheduledBy, 'scheduledByOptions');
            createFilterDropdown('primaryResource', primaryResources, 'primaryResourceOptions');
            
            // Populate SLA customer filter separately
            populateSelect('slaCustomerFilter', customers);
            
            // Add event listeners
            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', toggleFilterDropdown);
            });
            
            document.addEventListener('click', closeAllDropdowns);
            
            document.getElementById('slaCustomerFilter').addEventListener('change', updateSLAPivot);
            document.getElementById('resetSlaFilter').addEventListener('click', () => {
                document.getElementById('slaCustomerFilter').value = '';
                updateSLAPivot();
            });
            
            document.getElementById('clearAllFilters').addEventListener('click', clearAllFilters);
        }
        
        function createFilterDropdown(filterType, options, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // Add "Select All" option
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'filter-option select-all';
            selectAllDiv.innerHTML = `
                <input type="checkbox" id="${filterType}-select-all" ${activeFilters[filterType].length === 0 ? 'checked' : ''}>
                <label for="${filterType}-select-all">Select All</label>
            `;
            container.appendChild(selectAllDiv);
            
            // Add individual options
            options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'filter-option';
                const isChecked = activeFilters[filterType].length === 0 || activeFilters[filterType].includes(option);
                optionDiv.innerHTML = `
                    <input type="checkbox" id="${filterType}-${option.replace(/[^a-zA-Z0-9]/g, '_')}" 
                           value="${option}" ${isChecked ? 'checked' : ''}>
                    <label for="${filterType}-${option.replace(/[^a-zA-Z0-9]/g, '_')}">${option}</label>
                `;
                container.appendChild(optionDiv);
            });
            
            container.addEventListener('change', (e) => handleFilterChange(filterType, e));
            updateFilterButtonText(filterType);
        }
        
        function toggleFilterDropdown(e) {
            e.stopPropagation();
            const button = e.currentTarget;
            const dropdown = button.nextElementSibling;
            const isActive = button.classList.contains('active');
            
            // Close all other dropdowns
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
                btn.nextElementSibling.classList.remove('show');
            });
            
            if (!isActive) {
                button.classList.add('active');
                dropdown.classList.add('show');
                
                // Position the dropdown
                const buttonRect = button.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                
                dropdown.style.top = (buttonRect.bottom + scrollTop + 2) + 'px';
                dropdown.style.left = (buttonRect.left + scrollLeft) + 'px';
                dropdown.style.width = buttonRect.width + 'px';
                
                // Ensure dropdown doesn't go off screen
                const dropdownRect = dropdown.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                if (dropdownRect.bottom > viewportHeight) {
                    dropdown.style.top = (buttonRect.top + scrollTop - dropdown.offsetHeight - 2) + 'px';
                }
                
                if (dropdownRect.right > viewportWidth) {
                    dropdown.style.left = (buttonRect.right + scrollLeft - dropdown.offsetWidth) + 'px';
                }
            }
        }
        
        function closeAllDropdowns(e) {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.nextElementSibling.classList.remove('show');
                });
            }
        }
        
        function handleFilterChange(filterType, e) {
            const target = e.target;
            if (!target.matches('input[type="checkbox"]')) return;
            
            const container = document.getElementById(filterType === 'customer' ? 'customerOptions' :
                                                   filterType === 'status' ? 'statusOptions' :
                                                   filterType === 'priority' ? 'priorityOptions' :
                                                   filterType === 'region' ? 'regionOptions' :
                                                   filterType === 'scheduledBy' ? 'scheduledByOptions' :
                                                   'primaryResourceOptions');
            
            if (target.id.includes('select-all')) {
                const isChecked = target.checked;
                const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([id*="select-all"])');
                checkboxes.forEach(checkbox => checkbox.checked = isChecked);
                
                if (isChecked) {
                    activeFilters[filterType] = [];
                } else {
                    activeFilters[filterType] = Array.from(checkboxes).map(cb => cb.value);
                }
            } else {
                const selectAllCheckbox = container.querySelector('input[id*="select-all"]');
                const checkboxes = container.querySelectorAll('input[type="checkbox"]:not([id*="select-all"])');
                const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
                
                if (checkedBoxes.length === checkboxes.length) {
                    selectAllCheckbox.checked = true;
                    activeFilters[filterType] = [];
                } else if (checkedBoxes.length === 0) {
                    selectAllCheckbox.checked = false;
                    activeFilters[filterType] = Array.from(checkboxes).map(cb => cb.value);
                } else {
                    selectAllCheckbox.checked = false;
                    activeFilters[filterType] = checkedBoxes.map(cb => cb.value);
                }
            }
            
            updateFilterButtonText(filterType);
            applyFilters();
        }
        
        function updateFilterButtonText(filterType) {
            const button = document.querySelector(`[data-filter="${filterType}"]`);
            const textSpan = button.querySelector('.filter-text');
            const countSpan = button.querySelector('.filter-count');
            
            const selectedCount = activeFilters[filterType].length;
            const totalCount = document.getElementById(filterType === 'customer' ? 'customerOptions' :
                                                     filterType === 'status' ? 'statusOptions' :
                                                     filterType === 'priority' ? 'priorityOptions' :
                                                     filterType === 'region' ? 'regionOptions' :
                                                     filterType === 'scheduledBy' ? 'scheduledByOptions' :
                                                     'primaryResourceOptions')
                                      .querySelectorAll('input[type="checkbox"]:not([id*="select-all"])').length;
            
            if (selectedCount === 0) {
                textSpan.textContent = `All ${filterType === 'customer' ? 'Customers' :
                                              filterType === 'status' ? 'Statuses' :
                                              filterType === 'priority' ? 'Priorities' :
                                              filterType === 'region' ? 'Regions' :
                                              filterType === 'scheduledBy' ? 'Schedulers' :
                                              'Resources'}`;
                countSpan.textContent = '';
            } else {
                textSpan.textContent = selectedCount === 1 ? 
                    activeFilters[filterType][0] : 
                    `${selectedCount} selected`;
                countSpan.textContent = `(${selectedCount}/${totalCount})`;
            }
        }
        
        function clearAllFilters() {
            Object.keys(activeFilters).forEach(filterType => {
                activeFilters[filterType] = [];
                
                const container = document.getElementById(filterType === 'customer' ? 'customerOptions' :
                                                         filterType === 'status' ? 'statusOptions' :
                                                         filterType === 'priority' ? 'priorityOptions' :
                                                         filterType === 'region' ? 'regionOptions' :
                                                         filterType === 'scheduledBy' ? 'scheduledByOptions' :
                                                         'primaryResourceOptions');
                
                if (container) {
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = true);
                    updateFilterButtonText(filterType);
                }
            });
            
            applyFilters();
        }
        
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">All Customers</option>';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }
        
        function applyFilters() {
            filteredData = originalData.filter(ticket => {
                return (activeFilters.customer.length === 0 || activeFilters.customer.includes(ticket.Customer)) &&
                       (activeFilters.status.length === 0 || activeFilters.status.includes(ticket.Status) || activeFilters.status.includes(ticket.Satus)) &&
                       (activeFilters.priority.length === 0 || activeFilters.priority.includes(ticket.Priority)) &&
                       (activeFilters.region.length === 0 || activeFilters.region.includes(ticket.Region)) &&
                       (activeFilters.scheduledBy.length === 0 || activeFilters.scheduledBy.includes(ticket['Scheduled By'])) &&
                       (activeFilters.primaryResource.length === 0 || activeFilters.primaryResource.includes(ticket['Primary Resource']));
            });
            
            updateDashboard();
        }
        
        function updateDashboard() {
            updateSummaryStats();
            updatePivotTables();
            makeCountsClickable();
        }
        
        function updateSummaryStats() {
            const total = filteredData.length;
            const completed = filteredData.filter(t => {
                const status = (t.Status || t.Satus || '').toString().toLowerCase();
                return status.includes('complete') || status === 'completed' || status === 'closed';
            }).length;
            
            // Updated SLA breach detection for your Excel formula results
            const slaBreaches = filteredData.filter(t => {
                const slaStatus = (t['SLA Status'] || '').toString().toLowerCase();
                
                // Check for your specific Excel formula results
                return slaStatus.includes('failed sla') ||
                       slaStatus.includes('fail');
            }).length;
            
            const active = total - completed;
            
            // Debug logging to help identify SLA issues
            console.log('Summary Stats Debug:');
            console.log('Total tickets:', total);
            console.log('Completed tickets:', completed);
            console.log('SLA breaches found:', slaBreaches);
            console.log('Active tickets:', active);
            
            // Show sample SLA statuses for debugging
            const slaStatuses = [...new Set(filteredData.map(t => t['SLA Status']).filter(s => s))];
            console.log('All SLA Status values found:', slaStatuses);
            
            document.getElementById('totalTickets').textContent = total;
            document.getElementById('completedTickets').textContent = completed;
            document.getElementById('slaBreaches').textContent = slaBreaches;
            document.getElementById('activeTickets').textContent = active;
        }
        
        function updatePivotTables() {
            updateStatusPivot();
            updateSLAPivot();
            updateSLARiskPivot();
            updatePriorityPivot();
            updateRegionPivot();
            updateCustomerPivot();
            updateEngineerPivot();
            updateSchedulerPivot();
        }
        
        function updateSLARiskPivot() {
            const today = new Date();
            const endOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
            
            const atRiskTickets = filteredData.filter(ticket => {
    const status = ticket.Status || ticket.Satus || '';
    const slaStatus = (ticket['SLA Status'] || '').toString().toLowerCase();

    // Exclude completed or already missed SLA tickets
    if (status === 'Complete') return false;
    if (
        slaStatus.includes('missed sla') ||
        slaStatus.includes('out of sla') ||
        slaStatus.includes('failed sla') ||
        slaStatus.includes('fail')
    ) {
        return false;
    }

    const sladue = calculateSLADueDate(ticket);
    return sladue && sladue <= endOfToday;
});
            
            if (atRiskTickets.length === 0) {
                document.getElementById('slaRiskPivot').innerHTML = 
                    '<div class="no-data">No tickets currently at risk of failing SLA</div>';
                return;
            }
            
           const riskCategories = {
    'Needs Attention': [],
    'High Risk': [],
    'Low Risk': []
};

atRiskTickets.forEach(ticket => {
    const priority = ticket.Priority || '';

    if (priority === 'P1') {
        riskCategories['Needs Attention'].push(ticket);
    } else if (priority === 'P2' || priority === 'P3') {
        riskCategories['High Risk'].push(ticket);
    } else {
        riskCategories['Low Risk'].push(ticket);
    }
});
            
            const totalAtRisk = atRiskTickets.length;
            
            const tableData = [
    ['Risk Level', 'Count', 'Percentage', 'Top Customer']
].concat(
    Object.entries(riskCategories)
        .filter(([risk, tickets]) => tickets.length > 0)
        .map(([risk, tickets]) => {
            const topCustomer = getTopCustomer(tickets);
            return [
                risk,
                tickets.length,
                ((tickets.length / totalAtRisk) * 100).toFixed(1) + '%',
                topCustomer
            ];
        })
);
            
            window.slaRiskTickets = riskCategories;
            
            let html = createPivotTable(tableData);
            
            setTimeout(() => {
                const countCells = document.querySelectorAll('#slaRiskPivot tbody tr td:nth-child(2)');
                countCells.forEach((cell, index) => {
                    const riskLevels = Object.keys(riskCategories).filter(key => riskCategories[key].length > 0);
                    if (riskLevels[index]) {
                        const riskLevel = riskLevels[index];
                        const riskId = riskLevel.replace(/\s+/g, '').toLowerCase();
                        cell.innerHTML = `<span class="clickable-count" onclick="showTicketDetails('${riskId}', '${riskLevel}')">${cell.textContent}</span>`;
                    }
                });
            }, 100);
            
            document.getElementById('slaRiskPivot').innerHTML = html;
        }
        
        function calculateSLADueDate(ticket) {
            const createDate = convertExcelDate(ticket['Create Date']);
            const createTime = convertExcelDate(ticket['Create Time']);
            const priority = ticket.Priority || '';
            
            if (!createDate && !createTime) return null;
            
            const startTime = createTime || createDate;
            
            if (!startTime || isNaN(startTime.getTime())) return null;
            
            const slaHours = {
                'P1': 4,
                'P2': 8,
                'P3': 24,
                'P4': 48
            };
            
            const hours = slaHours[priority] || 24;
            
            const slaDue = new Date(startTime);
            slaDue.setHours(slaDue.getHours() + hours);
            
            return slaDue;
        }
        
        function getAverageHoursUntilDue(tickets) {
            const now = new Date();
            let totalHours = 0;
            let validTickets = 0;
            
            tickets.forEach(ticket => {
                const sladue = calculateSLADueDate(ticket);
                if (sladue) {
                    const hoursUntilDue = (sladue - now) / (1000 * 60 * 60);
                    totalHours += hoursUntilDue;
                    validTickets++;
                }
            });
            
            if (validTickets === 0) return 'N/A';
            
            const avgHours = totalHours / validTickets;
            
            if (avgHours < 0) return 'Overdue';
            if (avgHours < 1) return '<1 hour';
            if (avgHours < 24) return Math.round(avgHours) + ' hours';
            
            const days = Math.round(avgHours / 24);
            return days + (days === 1 ? ' day' : ' days');
        }
        
        function makeCountsClickable() {
            setTimeout(() => {
                makeTableCountsClickable('statusPivot', 'status');
                makeTableCountsClickable('priorityPivot', 'priority');
                makeTableCountsClickable('regionPivot', 'region');
                makeTableCountsClickable('customerPivot', 'customer');
                makeTableCountsClickable('engineerPivot', 'engineer');
                makeTableCountsClickable('schedulerPivot', 'scheduler');
            }, 100);
        }
        
        function makeTableCountsClickable(tableId, pivotType) {
            const table = document.querySelector(`#${tableId} table`);
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    const nameCell = cells[0];
                    const countCell = cells[1];
                    
                    if (countCell && !isNaN(parseInt(countCell.textContent))) {
                        const itemName = nameCell.textContent.trim();
                        const count = countCell.textContent.trim();
                        
                        countCell.innerHTML = `<span class="clickable-count" onclick="showFilteredTickets('${pivotType}', '${itemName.replace(/'/g, '\\\'')}')">${count}</span>`;
                    }
                }
            });
        }
        
        function showFilteredTickets(pivotType, itemName) {
            let tickets = [];
            let title = '';
            
            switch(pivotType) {
                case 'status':
                    tickets = filteredData.filter(t => (t.Status || t.Satus || 'Unknown') === itemName);
                    title = `${itemName} Status Tickets (${tickets.length})`;
                    break;
                    
                case 'priority':
                    tickets = filteredData.filter(t => (t.Priority || 'Unknown') === itemName);
                    title = `${itemName} Priority Tickets (${tickets.length})`;
                    break;
                    
                case 'region':
                    tickets = filteredData.filter(t => (t.Region || 'Unknown') === itemName);
                    title = `${itemName} Region Tickets (${tickets.length})`;
                    break;
                    
                case 'customer':
                    tickets = filteredData.filter(t => (t.Customer || 'Unknown') === itemName);
                    title = `${itemName} Tickets (${tickets.length})`;
                    break;
                    
                case 'engineer':
                    tickets = filteredData.filter(t => (t['Primary Resource'] || 'Unassigned') === itemName);
                    title = `${itemName} - Assigned Tickets (${tickets.length})`;
                    break;
                    
                case 'scheduler':
                    tickets = filteredData.filter(t => (t['Scheduled By'] || 'Unassigned') === itemName);
                    title = `${itemName} - Scheduled Tickets (${tickets.length})`;
                    break;
                    
                default:
                    tickets = [];
            }
            
            if (tickets.length === 0) {
                alert('No tickets found for this category.');
                return;
            }
            
            showTicketModal(title, tickets);
        }
        
        function showTicketModal(title, tickets) {
            document.getElementById('modalTitle').textContent = title;
            
            const ticketListHtml = tickets.map(ticket => {
                let createDateTime = 'N/A';
                
                if (ticket['Create Date']) {
                    try {
                        const createDate = convertExcelDate(ticket['Create Date']);
                        if (createDate && !isNaN(createDate.getTime())) {
                            createDateTime = createDate.toLocaleDateString('en-GB') + ' ' + createDate.toLocaleTimeString('en-GB');
                        } else {
                            createDateTime = ticket['Create Date'].toString();
                        }
                    } catch (e) {
                        createDateTime = ticket['Create Date'].toString();
                    }
                }
                
                let createTimeDisplay = '';
                if (ticket['Create Time']) {
                    try {
                        const createTime = convertExcelDate(ticket['Create Time']);
                        if (createTime && !isNaN(createTime.getTime())) {
                            createTimeDisplay = ' (Time: ' + createTime.toLocaleTimeString('en-GB') + ')';
                        } else {
                            createTimeDisplay = ' (Time: ' + ticket['Create Time'].toString() + ')';
                        }
                    } catch (e) {
                        createTimeDisplay = ' (Time: ' + ticket['Create Time'].toString() + ')';
                    }
                }
                
                let scheduledDate = 'N/A';
                if (ticket['Scheduled Date']) {
                    try {
                        const schedDate = convertExcelDate(ticket['Scheduled Date']);
                        if (schedDate && !isNaN(schedDate.getTime())) {
                            scheduledDate = schedDate.toLocaleDateString('en-GB');
                        } else {
                            scheduledDate = ticket['Scheduled Date'].toString();
                        }
                    } catch (e) {
                        scheduledDate = ticket['Scheduled Date'].toString();
                    }
                }
                
                let scheduledTime = '';
                if (ticket['Scheduled time']) {
                    try {
                        const schedTime = convertExcelDate(ticket['Scheduled time']);
                        if (schedTime && !isNaN(schedTime.getTime())) {
                            scheduledTime = ' at ' + schedTime.toLocaleTimeString('en-GB');
                        } else {
                            scheduledTime = ' at ' + ticket['Scheduled time'].toString();
                        }
                    } catch (e) {
                        scheduledTime = ' at ' + ticket['Scheduled time'].toString();
                    }
                }
                
                return `
                    <div class="ticket-item">
                        <div class="ticket-number">${ticket['Ticket Number'] || 'N/A'}</div>
                        <div class="ticket-title">${ticket['Ticket Title'] || 'No title available'}</div>
                        <div class="ticket-meta">
                            <strong>Customer:</strong> ${ticket.Customer || 'N/A'} | 
                            <strong>Priority:</strong> ${ticket.Priority || 'N/A'} | 
                            <strong>Status:</strong> ${ticket.Status || ticket.Satus || 'N/A'} |
                            <strong>SLA:</strong> ${ticket['SLA Status'] || 'N/A'}
                        </div>
                        <div class="ticket-meta">
                            <strong>Created:</strong> ${createDateTime}${createTimeDisplay}
                        </div>
                        <div class="ticket-meta">
                            <strong>Scheduled:</strong> ${scheduledDate}${scheduledTime} |
                            <strong>Resource:</strong> ${ticket['Primary Resource'] || 'N/A'}
                        </div>
                        <div class="ticket-meta">
                            <strong>City:</strong> ${ticket.City || 'N/A'} |
                            <strong>Region:</strong> ${ticket.Region || 'N/A'} |
                            <strong>Postcode:</strong> ${ticket.Postcode || 'N/A'}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('ticketList').innerHTML = ticketListHtml;
            document.getElementById('ticketModal').style.display = 'flex';
        }
        
        function convertExcelDate(excelDate) {
            if (typeof excelDate === 'number') {
                const excelEpoch = new Date(1900, 0, 1);
                const jsDate = new Date(excelEpoch.getTime() + (excelDate - 1) * 24 * 60 * 60 * 1000);
                
                if (excelDate > 59) {
                    jsDate.setTime(jsDate.getTime() - 24 * 60 * 60 * 1000);
                }
                
                return jsDate;
            }
            
            if (excelDate instanceof Date) {
                return excelDate;
            }
            
            if (typeof excelDate === 'string') {
                const parsed = new Date(excelDate);
                return isNaN(parsed.getTime()) ? null : parsed;
            }
            
            return null;
        }
        
        function showTicketDetails(riskId, riskLevel) {
            const tickets = window.slaRiskTickets[riskLevel] || [];
            
            if (tickets.length === 0) {
                alert('No tickets found for this category.');
                return;
            }
            
            showTicketModal(`${riskLevel} Tickets (${tickets.length})`, tickets);
        }
        
        function closeTicketModal() {
            document.getElementById('ticketModal').style.display = 'none';
        }
        
        document.getElementById('ticketModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTicketModal();
            }
        });
        
        function getTopCustomer(tickets) {
            const customerCounts = {};
            tickets.forEach(ticket => {
                const customer = ticket.Customer || 'Unknown';
                customerCounts[customer] = (customerCounts[customer] || 0) + 1;
            });
            
            const sortedCustomers = Object.entries(customerCounts)
                .sort((a, b) => b[1] - a[1]);
            
            return sortedCustomers.length > 0 ? 
                `${sortedCustomers[0][0]} (${sortedCustomers[0][1]})` : 'None';
        }
        
        function toggleView(pivotType, viewType) {
            const buttons = document.querySelectorAll(`[onclick*="${pivotType}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const tableDiv = document.getElementById(`${pivotType}Pivot`);
            const chartCanvas = document.getElementById(`${pivotType}Chart`);
            
            if (viewType === 'table') {
                tableDiv.style.display = 'block';
                if (chartCanvas) chartCanvas.style.display = 'none';
            } else {
                tableDiv.style.display = 'none';
                if (chartCanvas) {
                    chartCanvas.style.display = 'block';
                    createChart(pivotType, chartCanvas);
                }
            }
        }
        
        function createChart(pivotType, canvas) {
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let data, labels, title;
            
            switch(pivotType) {
                case 'status':
                    const statusCounts = groupBy(filteredData, t => t.Status || t.Satus || 'Unknown');
                    labels = Object.keys(statusCounts);
                    data = Object.values(statusCounts).map(tickets => tickets.length);
                    title = 'Tickets by Status';
                    break;
                    
                case 'priority':
                    const priorityCounts = groupBy(filteredData, t => t.Priority || 'Unknown');
                    const priorityOrder = ['P1', 'P2', 'P3', 'P4', 'Unknown'];
                    labels = priorityOrder.filter(p => priorityCounts[p]);
                    data = labels.map(p => priorityCounts[p].length);
                    title = 'Tickets by Priority';
                    break;
                    
                case 'region':
                    const regionCounts = groupBy(filteredData, t => t.Region || 'Unknown');
                    const sortedRegions = Object.entries(regionCounts)
                        .sort((a, b) => b[1].length - a[1].length)
                        .slice(0, 8);
                    labels = sortedRegions.map(([region]) => region);
                    data = sortedRegions.map(([, tickets]) => tickets.length);
                    title = 'Top Regions';
                    break;
                    
                case 'slaRisk':
                    const atRisk = filteredData.filter(t => {
                        const status = t.Status || t.Satus || '';
                        const slaStatus = t['SLA Status'] || '';
                        return status !== 'Complete' && 
                               (slaStatus.includes('Out of SLA') || status === 'Action Required');
                    });
                    labels = ['At Risk', 'Not At Risk'];
                    data = [atRisk.length, filteredData.length - atRisk.length];
                    title = 'SLA Risk Overview';
                    break;
                    
                default:
                    return;
            }
            
            createBarChart(ctx, canvas, labels, data, title);
        }
        
        function createBarChart(ctx, canvas, labels, data, title) {
            const padding = 60;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const barWidth = chartWidth / labels.length * 0.8;
            const maxValue = Math.max(...data);
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, 30);
            
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'];
            
            data.forEach((value, index) => {
                const barHeight = (value / maxValue) * chartHeight * 0.8;
                const x = padding + (index * chartWidth / labels.length) + (chartWidth / labels.length - barWidth) / 2;
                const y = canvas.height - padding - barHeight;
                
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                ctx.fillStyle = '#2c3e50';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value, x + barWidth / 2, y - 5);
                
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.save();
                ctx.translate(x + barWidth / 2, canvas.height - padding + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(labels[index], 0, 0);
                ctx.restore();
            });
        }
        
        function updateStatusPivot() {
            const statusCounts = groupBy(filteredData, t => t.Status || t.Satus || 'Unknown');
            const html = createPivotTable([
                ['Status', 'Count', 'Percentage']
            ].concat(
                Object.entries(statusCounts)
                    .sort((a, b) => b[1].length - a[1].length)
                    .map(([status, tickets]) => [
                        status,
                        tickets.length,
                        ((tickets.length / filteredData.length) * 100).toFixed(1) + '%'
                    ])
            ));
            document.getElementById('statusPivot').innerHTML = html;
        }
        
        function updateSLAPivot() {
    const slaCustomerFilter = document.getElementById('slaCustomerFilter').value;
    let slaData = filteredData;
    if (slaCustomerFilter) {
        slaData = filteredData.filter(t => t.Customer === slaCustomerFilter);
    }

    if (slaData.length === 0) {
        document.getElementById('slaPivot').innerHTML = '<div class="no-data">No data available for selected customer</div>';
        return;
    }

    // --- This is the fixed stats block ---
   const totalTickets = slaData.length;
const metSLA = slaData.filter(t => {
    const status = (t['SLA Status'] || '').toString().toLowerCase().trim();
    return (
        status === 'completed within sla' ||
        status === 'still within sla' ||
        status === 'within sla' ||
        status === 'met sla'
    );
}).length;
const missedSLA = slaData.filter(t => {
    const status = (t['SLA Status'] || '').toString().toLowerCase().trim();
    return (
        status === 'failed sla' ||
        status === 'missed sla' ||
        status === 'out of sla'
    );
}).length;
const slaPerformance = totalTickets > 0 ? ((metSLA / totalTickets) * 100).toFixed(1) : '0';

    const summaryHtml = `
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold;">${totalTickets}</div>
                    <div style="font-size: 0.9rem;">Total Tickets</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #90EE90;">${metSLA}</div>
                    <div style="font-size: 0.9rem;">Met SLA</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #FFB6C1;">${missedSLA}</div>
                    <div style="font-size: 0.9rem;">Missed SLA</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #FFD700;">${slaPerformance}%</div>
                    <div style="font-size: 0.9rem;">SLA Performance</div>
                </div>
            </div>
            ${slaCustomerFilter ? `<div style="text-align: center; margin-top: 10px; font-style: italic;">Showing results for: ${slaCustomerFilter}</div>` : ''}
        </div>
    `;

    // Keep your table rendering as before!
    const slaCounts = groupBy(slaData, t => t['SLA Status'] || 'Unknown');
    const slaTableData = [
        ['SLA Status', 'Count', 'Percentage']
    ].concat(
        Object.entries(slaCounts)
            .sort((a, b) => b[1].length - a[1].length)
            .map(([sla, tickets]) => [
                sla,
                tickets.length,
                ((tickets.length / slaData.length) * 100).toFixed(1) + '%'
            ])
    );

    const tableHtml = createPivotTable(slaTableData);
    document.getElementById('slaPivot').innerHTML = summaryHtml + tableHtml;
}
        
        function updatePriorityPivot() {
            const priorityCounts = groupBy(filteredData, t => t.Priority || 'Unknown');
            const priorityOrder = ['P1', 'P2', 'P3', 'P4', 'Unknown'];
            const html = createPivotTable([
                ['Priority', 'Count', 'Percentage']
            ].concat(
                priorityOrder
                    .filter(p => priorityCounts[p])
                    .map(priority => [
                        priority,
                        priorityCounts[priority].length,
                        ((priorityCounts[priority].length / filteredData.length) * 100).toFixed(1) + '%'
                    ])
            ));
            document.getElementById('priorityPivot').innerHTML = html;
        }
        
        function updateRegionPivot() {
            const regionCounts = groupBy(filteredData, t => t.Region || 'Unknown');
            const html = createPivotTable([
                ['Region', 'Count', 'Percentage']
            ].concat(
                Object.entries(regionCounts)
                    .sort((a, b) => b[1].length - a[1].length)
                    .slice(0, 10)
                    .map(([region, tickets]) => [
                        region,
                        tickets.length,
                        ((tickets.length / filteredData.length) * 100).toFixed(1) + '%'
                    ])
            ));
            document.getElementById('regionPivot').innerHTML = html;
        }
        
        function updateCustomerPivot() {
            const customerCounts = groupBy(filteredData, t => t.Customer || 'Unknown');
            const html = createPivotTable([
                ['Customer', 'Count', 'Avg Priority']
            ].concat(
                Object.entries(customerCounts)
                    .sort((a, b) => b[1].length - a[1].length)
                    .slice(0, 10)
                    .map(([customer, tickets]) => {
                        const priorities = tickets.map(t => t.Priority).filter(p => p);
                        const avgPriority = priorities.length > 0 
                            ? (priorities.reduce((sum, p) => sum + parseInt(p.substring(1) || '0'), 0) / priorities.length).toFixed(1)
                            : 'N/A';
                        return [
                            customer,
                            tickets.length,
                            avgPriority !== 'N/A' ? 'P' + avgPriority : 'N/A'
                        ];
                    })
            ));
            document.getElementById('customerPivot').innerHTML = html;
        }
        
        let showAllEngineers = false; // State variable

function updateEngineerPivot() {
    const engineerCounts = groupBy(filteredData, t => t['Primary Resource'] || 'Unassigned');
    // Build stats array first
    const engineerStats = Object.entries(engineerCounts).map(([engineer, tickets]) => {
        // Completed on schedule
        const scheduledTickets = tickets.filter(t => t['Scheduled Date']);
        const completedOnSchedule = scheduledTickets.filter(t => {
            const status = (t.Status || t.Satus || '').toString().toLowerCase();
            if (!status.includes('complete') && status !== 'closed') return false;
            const schedDate = t['Scheduled Date'] ? convertExcelDate(t['Scheduled Date']) : null;
            const compDate = t['Complete Date'] ? convertExcelDate(t['Complete Date']) : null;
            if (!schedDate || !compDate) return false;
            return schedDate.toDateString() === compDate.toDateString();
        }).length;
        const onTimeRate = scheduledTickets.length > 0
            ? ((completedOnSchedule / scheduledTickets.length) * 100)
            : null;

        // Average ticket per shift logic
        const ticketsByDate = {};
        scheduledTickets.forEach(t => {
            const d = t['Scheduled Date'] ? convertExcelDate(t['Scheduled Date']) : null;
            if (!d) return;
            const dateStr = d.toDateString();
            if (!ticketsByDate[dateStr]) ticketsByDate[dateStr] = 0;
            ticketsByDate[dateStr]++;
        });
        const shiftCounts = Object.values(ticketsByDate);
        const avgTicketsPerShift =
            shiftCounts.length > 0
                ? (shiftCounts.reduce((a, b) => a + b, 0) / shiftCounts.length).toFixed(2)
                : 'N/A';

        return {
            engineer,
            totalTickets: tickets.length,
            completedOnSchedule,
            onTimeRate, // numeric for sorting
            onTimeRateDisplay: onTimeRate !== null ? onTimeRate.toFixed(1) + '%' : 'N/A',
            avgTicketsPerShift
        };
    });

    // Sort by On-Time Completion Rate descending
    engineerStats.sort((a, b) => (b.onTimeRate || 0) - (a.onTimeRate || 0));

    const htmlTable = createPivotTable([
        [
            'Engineer',
            'Total Tickets',
            'Completed On Schedule',
            'On-Time Completion Rate',
            'Average Ticket per Shift'
        ]
    ].concat(
        engineerStats.map(row => [
            row.engineer,
            row.totalTickets,
            row.completedOnSchedule,
            row.onTimeRateDisplay,
            row.avgTicketsPerShift
        ])
    ));

    // Scrollable container
    const scrollContainer = `
      <div style="max-height:400px;overflow-y:auto;border-radius:8px;border:1px solid #e1e1e1;">
        ${htmlTable}
      </div>
    `;

    document.getElementById('engineerPivot').innerHTML = scrollContainer;
}
        
        function groupBy(array, keyFunc) {
            return array.reduce((groups, item) => {
                const key = keyFunc(item);
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(item);
                return groups;
            }, {});
        }
        
        function createPivotTable(data) {
            if (!data || data.length === 0) {
                return '<div class="no-data">No data available</div>';
            }
            
            let html = '<table class="pivot-table">';
            
            html += '<thead><tr>';
            data[0].forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead>';
            
            html += '<tbody>';
            for (let i = 1; i < data.length; i++) {
                html += '<tr>';
                data[i].forEach(cell => {
                    html += `<td>${cell}</td>`;
                });
                html += '</tr>';
            }
            html += '</tbody>';
            
            html += '</table>';
            return html;
        }
    </script>
</body>
</html>
